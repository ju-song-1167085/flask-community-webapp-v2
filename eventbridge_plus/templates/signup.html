{% extends "base.html" %}
{% set active_page = 'signup' %}

{% block title %}{{ tab_title }}{% endblock %}

{% block content %}
<h1 class="page-title">{{ tab_title }}</h1>

<style>
/* Center the auth card on the page */
  .auth-wrap{
    min-height: clamp(560px, 85vh, 1000px);
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--light-bg);
    padding: 2rem 0;
  }

  /* Card container */
  .signup-card{
    width: 100%;
    max-width: 680px;
    border: 0;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    overflow: hidden; /* ensures the banner respects rounded corners */
    background: #fff;
  }

  /* Card header background */
  .signup-card .card-header.bg-soft {
    background: var(--light-bg) !important;
  }

</style>

<div class="auth-wrap container">
  <div class="card signup-card">
    {% if signup_successful %}
      <!-- Success state after account creation -->
      <div class="card-body p-4 p-md-5 text-center">
        <h2 class="h4 mb-3 fw-bold text-brand">
          <i class="bi bi-check-circle me-2"></i>Welcome to EventBridge+!
        </h2>
        <p class="text-muted mb-4">Your account has been created successfully.</p>
        <a class="btn btn-activeloop btn-lg" href="{{ url_for('login') }}">
          <i class="bi bi-box-arrow-in-right me-2"></i>Login Now
        </a>
      </div>
    {% else %}
      <!--  Title banner -->
      <div class="card-header bg-soft">
        <h2 class="fw-bold mb-1 fs-2 text-brand">Create your account</h2>
        <p class="text-muted mb-0">It only takes a minute to get started.</p>
      </div>

      <div class="card-body p-4 p-md-5">
        <!-- Signup form -->
        <form action="{{ url_for('signup') }}" method="post" novalidate>
          {% if next_url %}<input type="hidden" name="next" value="{{ next_url }}">{% endif %}
          <!-- Name fields -->
          <div class="row g-3">
            <div class="col-md-6">
              <label for="first_name" class="form-label">First Name</label>
              <input type="text"
                     class="form-control{% if first_name_error %} is-invalid{% endif %}"
                     id="first_name" name="first_name"
                     maxlength="50" autocomplete="given-name"
                     value="{{ first_name or '' }}" required>
              <div class="invalid-feedback">{{ first_name_error }}</div>
              <div class="subtle mt-1">Use your legal first name.</div>
            </div>

            <div class="col-md-6">
              <label for="last_name" class="form-label">Last Name</label>
              <input type="text"
                     class="form-control{% if last_name_error %} is-invalid{% endif %}"
                     id="last_name" name="last_name"
                     maxlength="50" autocomplete="family-name"
                     value="{{ last_name or '' }}" required>
              <div class="invalid-feedback">{{ last_name_error }}</div>
              <div class="subtle mt-1">Family/surname as shown on ID.</div>
            </div>
          </div>

          <!-- Username -->
          <div class="mt-3">
            <label for="username" class="form-label">Username</label>
            <input type="text"
                   class="form-control{% if username_error %} is-invalid{% endif %}"
                   id="username" name="username"
                   maxlength="20" pattern="^[A-Za-z0-9_.]+$"
                   title="Letters, numbers, underscores, and dots only"
                   autocomplete="username"
                   value="{{ username or '' }}" required>
            <div class="invalid-feedback">{{ username_error }}</div>
            <div class="subtle">
              <i class="bi bi-info-circle me-1"></i>
              Letters, numbers, underscores, and dots only, max 20 characters
            </div>
          </div>

          <!-- Email -->
          <div class="mt-3">
            <label for="email" class="form-label">Email</label>
            <input type="email"
                   class="form-control{% if email_error %} is-invalid{% endif %}"
                   id="email" name="email"
                   maxlength="320" autocomplete="email"
                   value="{{ email or '' }}" required>
            <div class="invalid-feedback">{{ email_error }}</div>
            <div class="subtle mt-1">We'll only use this for account notifications.</div>
          </div>

          <!-- Location -->
          <div class="mt-3">
            <label for="location" class="form-label">Location</label>
            <select class="form-select{% if location_error %} is-invalid{% endif %}"
                    id="location" name="location" required>
              <option value="" disabled {% if not location %}selected{% endif %}>
                Select your location
              </option>
              {% for city in available_locations %}
                <option value="{{ city }}" {% if location == city %}selected{% endif %}>
                  {{ city }}
                </option>
              {% endfor %}
            </select>
            <div class="invalid-feedback">{{ location_error }}</div>
          </div>

          <!-- Password -->
          <div class="mt-3">
            <label for="password" class="form-label">Password</label>
            <div class="input-group">
              <input type="password"
                     class="form-control{% if password_error %} is-invalid{% endif %}"
                     id="password" name="password"
                     placeholder="Create a strong password…"
                     minlength="8"
                     pattern="(?=.*[A-Za-z])(?=.*\d).{8,}"
                     title="At least 8 characters with letters and numbers"
                     autocomplete="new-password" required>
              <button class="btn btn-outline-secondary" type="button" id="togglePwd1">Show</button>
            </div>
            <div class="invalid-feedback">{{ password_error }}</div>
            <small id="capsHint1" class="text-danger d-none">Caps Lock appears to be on</small>
            <div class="subtle mt-1">
              <i class="bi bi-shield-check me-1"></i>
              At least 8 characters with letters and numbers and special characters
            </div>
          </div>

          <!-- Password Confirm -->
          <div class="mt-3">
            <label for="password_confirm" class="form-label">Confirm Password</label>
            <div class="input-group">
              <input type="password"
                     class="form-control{% if password_confirm_error %} is-invalid{% endif %}"
                     id="password_confirm" name="password_confirm"
                     placeholder="Re-enter your password…"
                     autocomplete="new-password" required>
              <button class="btn btn-outline-secondary" type="button" id="togglePwd2">Show</button>
            </div>
            <div class="invalid-feedback">{{ password_confirm_error }}</div>
            <small id="capsHint2" class="text-danger d-none">Caps Lock appears to be on</small>
            <div class="subtle mt-1">
              <i class="bi bi-check-circle me-1"></i>
              Must match the password above
            </div>
          </div>

          <!-- Submit -->
          <div class="d-grid mt-4">
            <button type="submit" class="btn btn-activeloop btn-lg">
              <i class="bi bi-person-plus me-2"></i>Join EventBridge+
            </button>
          </div>
        </form>
      </div>

      <div class="card-footer bg-light text-center">
        Already have an account?
        <a href="{{ url_for('login') }}" class="fw-semibold text-brand">Login here</a>
      </div>
    {% endif %}
  </div>
</div>

<script>
  function setupToggle(btnId, inputId, hintId){
    const btn = document.getElementById(btnId);
    const input = document.getElementById(inputId);
    const hint = document.getElementById(hintId);
    if(!btn || !input) return;
    btn.addEventListener('click', ()=>{
      const isText = input.type === 'text';
      input.type = isText ? 'password' : 'text';
      btn.textContent = isText ? 'Show' : 'Hide';
    });
    if(hint) {
      input.addEventListener('keyup', (e)=>{
        const on = e.getModifierState && e.getModifierState('CapsLock');
        hint.classList.toggle('d-none', !on);
      });
    }
  }
  setupToggle('togglePwd1','password','capsHint1');
  setupToggle('togglePwd2','password_confirm','capsHint2');
</script>
{% endblock %}