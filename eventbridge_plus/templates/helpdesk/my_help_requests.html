{% extends "base.html" %}

{% set active_page = 'helpdesk_home' %}

{% block title %}My Help Requests{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">
          <i class="bi bi-headset text-primary me-2"></i>
          My Help Requests
        </h1>
        <div class="d-flex gap-2">
          <a href="{{ url_for('faq') }}" class="btn btn-outline-info">
            <i class="bi bi-question-circle me-1"></i>
            FAQ
          </a>
          <a href="{{ url_for('submit_help_request') }}" class="btn btn-primary">
            <i class="bi bi-plus-circle me-1"></i>
            Submit New Request
          </a>
        </div>
      </div>

      <!-- Filters and Sorting -->
      <div class="card mb-4">
        <div class="card-body">
          <div class="row align-items-center">
            <div class="col-md-4">
              <label for="statusFilter" class="form-label">Filter by Status:</label>
              <select id="statusFilter" class="form-select">
                <option value="all" {% if current_status == 'all' %}selected{% endif %}>All Status</option>
                <option value="new" {% if current_status == 'new' %}selected{% endif %}>New</option>
                <option value="assigned" {% if current_status == 'assigned' %}selected{% endif %}>Assigned</option>
                <option value="blocked" {% if current_status == 'blocked' %}selected{% endif %}>Blocked</option>
                <option value="solved" {% if current_status == 'solved' %}selected{% endif %}>Solved</option>
              </select>
            </div>
             <div class="col-md-4">
               <label for="sortBy" class="form-label">Sort by:</label>
               <select id="sortBy" class="form-select">
                 <option value="last_activity_desc" {% if current_sort == 'last_activity_desc' %}selected{% endif %}>Most Recent Activity</option>
                 <option value="last_activity_asc" {% if current_sort == 'last_activity_asc' %}selected{% endif %}>Oldest Activity</option>
                 <option value="priority_desc" {% if current_sort == 'priority_desc' %}selected{% endif %}>Highest Priority</option>
                 <option value="priority_asc" {% if current_sort == 'priority_asc' %}selected{% endif %}>Lowest Priority</option>
                 <option value="title_asc" {% if current_sort == 'title_asc' %}selected{% endif %}>Title A-Z</option>
                 <option value="title_desc" {% if current_sort == 'title_desc' %}selected{% endif %}>Title Z-A</option>
               </select>
             </div>
          </div>
        </div>
      </div>

      {% if requests %}
        <div class="card">
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Request #</th>
                    <th>Title</th>
                    <th>Category</th>
                    <th>Priority</th>
                    <th>Status</th>
                    <th>Last Activity</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for request in requests %}
                  <tr>
                    <td>
                      <span class="fw-bold text-primary">#{{ request.request_id }}</span>
                    </td>
                    <td>
                      <a href="{{ url_for('view_help_request', request_id=request.request_id) }}" 
                         class="text-decoration-none text-dark fw-bold title-link">
                        <div class="text-truncate" style="max-width: 200px;" title="View details">
                          {{ request.title }}
                        </div>
                      </a>
                    </td>
                    <td>
                      <span class="badge bg-secondary">
                        {{ request.category.replace('_', ' ').title() }}
                      </span>
                    </td>
                    <td>
                      {% set priority_colors = {
                        'urgent': 'danger',
                        'high': 'warning', 
                        'medium': 'info',
                        'low': 'success'
                      } %}
                      <span class="badge bg-{{ priority_colors.get(request.priority, 'secondary') }}">
                        {{ (request.priority or 'unknown').title() }}
                      </span>
                    </td>
                    <td>
                      {% set status_colors = {
                        'new': 'primary',
                        'assigned': 'info',
                        'blocked': 'warning',
                        'solved': 'success'
                      } %}
                      <span class="badge bg-{{ status_colors.get(request.status, 'secondary') }}">
                        {{ (request.status or 'unknown').title() }}
                      </span>
                    </td>
                    <td>
                      <small class="text-muted">
                        {{ request.last_activity | nz_date }}<br>
                        {{ request.last_activity | nz_time12_upper }}
                      </small>
                    </td>
                    <td>
                      <a href="{{ url_for('view_help_request', request_id=request.request_id) }}" 
                         class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-eye me-1"></i>
                        View
                      </a>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>

      {% else %}
        <div class="text-center py-5">
          <i class="bi bi-inbox text-muted" style="font-size: 4rem;"></i>
          <h3 class="mt-3 text-muted">No Help Requests Yet</h3>
          <p class="text-muted">You haven't submitted any help requests yet.</p>
          <div class="d-flex gap-2 justify-content-center mt-3">
            <a href="{{ url_for('faq') }}" class="btn btn-outline-info">
              <i class="bi bi-question-circle me-1"></i>
              Check FAQ
            </a>
            <a href="{{ url_for('submit_help_request') }}" class="btn btn-primary">
              <i class="bi bi-plus-circle me-1"></i>
              Submit Request
            </a>
          </div>
        </div>
      {% endif %}
    </div>
  </div>
</div>

{% endblock %}

{% block scripts_extra %}
       <script>
       document.addEventListener('DOMContentLoaded', function() {
           const statusFilter = document.getElementById('statusFilter');
           const sortBy = document.getElementById('sortBy');
           
           function updateURL() {
               const url = new URL(window.location);
               url.searchParams.set('status', statusFilter.value);
               url.searchParams.set('sort_by', sortBy.value);
               window.location.href = url.toString();
           }
           
           statusFilter.addEventListener('change', updateURL);
           sortBy.addEventListener('change', updateURL);
       });
       </script>
{% endblock %}
