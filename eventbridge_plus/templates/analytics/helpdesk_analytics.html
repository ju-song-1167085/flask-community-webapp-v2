{% extends "base.html" %}

{% block title %}Helpdesk Analytics Dashboard{% endblock %}

{% block content %}

<div class="container-fluid py-4">
    
    <!-- Page Header -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="mb-0">Helpdesk Analytics Dashboard</h1>
                    <p class="text-muted mb-0">Helpdesk statistics and performance metrics</p>
                </div>
                {% if session.platform_role == 'super_admin' %}
                <a href="{{ url_for('admin_dashboard') }}" class="btn fw-bold d-inline-flex align-items-center" style="background: var(--brand-green); color: #fff; border-color: var(--brand-green); border-radius: var(--radius);">
                    <i class="bi bi-arrow-left me-2"></i>Back to Admin Dashboard
                </a>
                {% else %}
                <a href="{{ url_for('support_dashboard') }}" class="btn fw-bold d-inline-flex align-items-center" style="background: var(--brand-green); color: #fff; border-color: var(--brand-green); border-radius: var(--radius);">
                    <i class="bi bi-arrow-left me-2"></i>Back to Support Dashboard
                </a>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Period Filter -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h5 class="mb-0">Analytics Period</h5>
                    <p class="text-muted mb-0">Filter data by time period</p>
                </div>
                <div class="col-md-6">
                    <div class="d-flex justify-content-end">
                        <select id="periodFilter" class="form-select" style="max-width: 200px;">
                            <option value="all" {% if current_period == 'all' %}selected{% endif %}>All Time</option>
                            <option value="last_week" {% if current_period == 'last_week' %}selected{% endif %}>Last Week</option>
                            <option value="last_month" {% if current_period == 'last_month' %}selected{% endif %}>Last Month</option>
                            <option value="last_3_months" {% if current_period == 'last_3_months' %}selected{% endif %}>Last 3 Months</option>
                            <option value="last_6_months" {% if current_period == 'last_6_months' %}selected{% endif %}>Last 6 Months</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- KPI Cards -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card text-center h-100">
                <div class="card-body">
                    <i class="bi bi-ticket text-primary" style="font-size: 2.5rem;"></i>
                    <h2 class="mt-3 mb-1">{{ helpdesk_stats.total_requests }}</h2>
                    <p class="text-muted mb-0">Total Requests</p>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card text-center h-100">
                <div class="card-body">
                    <i class="bi bi-check-circle text-success" style="font-size: 2.5rem;"></i>
                    <h2 class="mt-3 mb-1">{{ helpdesk_stats.resolved_this_month }}</h2>
                    <p class="text-muted mb-0">Solved Requests</p>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card text-center h-100">
                <div class="card-body">
                    <i class="bi bi-clock text-info" style="font-size: 2.5rem;"></i>
                    <h2 class="mt-3 mb-1">{{ performance_metrics.avg_response_time|round(1) }}h</h2>
                    <p class="text-muted mb-0">Avg Response Time</p>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card text-center h-100">
                <div class="card-body">
                    <i class="bi bi-people-fill text-warning" style="font-size: 2.5rem;"></i>
                    <h2 class="mt-3 mb-1">{{ helpdesk_stats.active_support_staff }}</h2>
                    <p class="text-muted mb-0">Active Support Staff</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row g-3 mb-4">
        <!-- Request Status Chart -->
        <div class="col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="bi bi-pie-chart-fill text-primary me-2"></i>Request Status Distribution (Total: {{ helpdesk_stats.total_requests }})
                    </h5>
                    <div style="height: 350px; position: relative;">
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Category Breakdown Chart -->
        <div class="col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="bi bi-bar-chart-fill text-success me-2"></i>Request Categories (Total: {{ helpdesk_stats.total_requests }})
                    </h5>
                    <div style="height: 350px; position: relative;">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Request Trends Chart -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
            <h5 class="card-title">
                <i class="bi bi-graph-up text-info me-2"></i>Request Trends
            </h5>
            <div style="height: 450px; position: relative;">
                <canvas id="trendsChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Workload Dashboard Button -->
    <div class="text-center mb-4">
        <button type="button" class="btn btn-lg" style="background-color: #ec7a08; color: white; border: none;" data-bs-toggle="modal" data-bs-target="#workloadModal">
            <i class="bi bi-people-fill me-2"></i>View Support Staff Workload
        </button>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script>
// Register Chart.js plugins
Chart.register(ChartDataLabels);

document.addEventListener('DOMContentLoaded', function() {
    // Request Status Chart
    var statusCtx = document.getElementById('statusChart').getContext('2d');
    var statusChart = new Chart(statusCtx, {
        type: 'bar',
        data: {
            labels: ['New', 'Assigned', 'Solved', 'Blocked'],
            datasets: [{
                data: [{{ helpdesk_stats.new_requests }}, {{ helpdesk_stats.assigned_requests }}, {{ helpdesk_stats.solved_requests }}, {{ helpdesk_stats.blocked_requests }}],
                backgroundColor: ['#006400', '#FF7F50', '#6A5ACD', '#dc3545']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            var label = context.label || '';
                            var value = context.parsed.y || 0;
                            var total = context.dataset.data.reduce((a, b) => a + b, 0);
                            var percentage = ((value / total) * 100).toFixed(1);
                            return label + ': ' + value + ' requests (' + percentage + '%)';
                        }
                    }
                },
                datalabels: {
                    display: true,
                    color: 'white',
                    font: {
                        size: 16,
                        weight: 'bold'
                    },
                    formatter: function(value) {
                        return value;
                    },
                    anchor: 'center',
                    align: 'center',
                    offset: 0
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 10,
                        font: {
                            size: 12
                        }
                    }
                },
                x: {
                    ticks: {
                        font: {
                            size: 12
                        }
                    }
                }
            }
        }
    });

    // Category Chart
    var categoryCtx = document.getElementById('categoryChart').getContext('2d');
    var categoryChart = new Chart(categoryCtx, {
        type: 'doughnut',
        data: {
            labels: [{% for category in category_breakdown %}'{{ category.category.replace('_', ' ').title() }}'{% if not loop.last %},{% endif %}{% endfor %}],
            datasets: [{
                data: [{% for category in category_breakdown %}{{ category.count }}{% if not loop.last %},{% endif %}{% endfor %}],
                backgroundColor: ['#006400', '#FF7F50', '#6A5ACD', '#dc3545', '#4682B4', '#C0C0C0']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'right',
                    labels: {
                        font: {            
                            size: 16,
                            weight: 'normal',
                            family: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif'
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            var label = context.label || '';
                            var value = context.parsed || 0;
                            var total = context.dataset.data.reduce((a, b) => a + b, 0);
                            var percentage = ((value / total) * 100).toFixed(1);
                            return label + ': ' + value + ' requests (' + percentage + '%)';
                        }
                    }
                },
                datalabels: {
                    display: true,
                    color: 'white',
                    font: {
                        size: 16,
                        weight: 'bold',
                        family: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif'
                    },
                    formatter: function(value, context) {
                        var total = context.dataset.data.reduce((a, b) => a + b, 0);
                        var percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                        return percentage + '%';
                    }
                }
            }
        }
    });

    // Trends Chart
    var trendsCtx = document.getElementById('trendsChart').getContext('2d');
    var trendsChart = new Chart(trendsCtx, {
        type: 'line',
        data: {
            labels: [{% for trend in request_trends %}'{{ trend.month }}'{% if not loop.last %},{% endif %}{% endfor %}],
            datasets: [{
                label: 'Requests',
                data: [{% for trend in request_trends %}{{ trend.request_count }}{% if not loop.last %},{% endif %}{% endfor %}],
                borderColor: '#006400',
                backgroundColor: 'rgba(0, 100, 0, 0.1)',
                borderWidth: 4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });

});
</script>

<!-- Workload Dashboard Modal -->
<div class="modal fade" id="workloadModal" tabindex="-1" aria-labelledby="workloadModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="workloadModalLabel">
                    <i class="bi bi-people-fill text-warning me-2"></i>Support Staff Workload
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Workload Chart -->
                <div class="mb-4">
                    <h6 class="mb-3">Support Staff Workload Distribution</h6>
                    <div style="height: 400px; position: relative;">
                        <canvas id="workloadChart"></canvas>
                    </div>
                </div>
                
                <!-- Detailed Cards (Collapsible) -->
                <div class="mt-4">
                    <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#workloadDetails" aria-expanded="false" aria-controls="workloadDetails">
                        <i class="bi bi-chevron-down me-1"></i>View Details
                    </button>
                    
                    <div class="collapse mt-3" id="workloadDetails">
                        <div id="workloadDashboard">
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2 text-muted">Loading workload data...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
// Load workload dashboard when modal is shown
document.getElementById('workloadModal').addEventListener('shown.bs.modal', function () {
    // Create new canvas element to avoid reuse issues
    var chartContainer = document.querySelector('#workloadChart').parentElement;
    var oldCanvas = document.getElementById('workloadChart');
    var newCanvas = document.createElement('canvas');
    newCanvas.id = 'workloadChart';
    newCanvas.style.width = '100%';
    newCanvas.style.height = '400px';
    
    oldCanvas.remove();
    chartContainer.appendChild(newCanvas);
    
    loadWorkloadDashboard();
});


// Handle collapse button icon change
document.getElementById('workloadDetails').addEventListener('show.bs.collapse', function () {
    var button = document.querySelector('[data-bs-target="#workloadDetails"]');
    var icon = button.querySelector('i');
    icon.className = 'bi bi-chevron-up me-1';
});

document.getElementById('workloadDetails').addEventListener('hide.bs.collapse', function () {
    var button = document.querySelector('[data-bs-target="#workloadDetails"]');
    var icon = button.querySelector('i');
    icon.className = 'bi bi-chevron-down me-1';
});

function loadWorkloadDashboard() {
    fetch('/helpdesk/api/workload-dashboard')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayWorkloadDashboard(data.technicians);
            } else {
                document.getElementById('workloadDashboard').innerHTML = 
                    '<div class="alert alert-warning">Failed to load workload data: ' + (data.error || data.message || 'Unknown error') + '</div>';
            }
        })
        .catch(error => {
            console.error('Error loading workload dashboard:', error);
            document.getElementById('workloadDashboard').innerHTML = 
                '<div class="alert alert-danger">Error loading workload data: ' + error.message + '</div>';
        });
}

function displayWorkloadDashboard(workloadData) {
    // Create workload chart
    createWorkloadChart(workloadData);
    
    // Create detailed table
    var html = '';
    
    if (!workloadData || workloadData.length === 0) {
        html = '<div class="alert alert-info">No support staff found.</div>';
        document.getElementById('workloadDashboard').innerHTML = html;
        return;
    }
    
    // Sort by active count (descending)
    var sortedData = workloadData.sort(function(a, b) {
        return (b.active_count || 0) - (a.active_count || 0);
    });
    
    html += '<div class="table-responsive">';
    html += '<table class="table table-hover" id="workloadTable">';
    html += '<thead class="table-light">';
    html += '<tr>';
    html += '<th onclick="sortTable(0)" style="cursor: pointer;">Staff Name <i class="bi bi-arrow-down-up"></i></th>';
    html += '<th onclick="sortTable(1)" style="cursor: pointer;">Role <i class="bi bi-arrow-down-up"></i></th>';
    html += '<th class="text-center" onclick="sortTable(2)" style="cursor: pointer;">Active <i class="bi bi-arrow-down-up"></i></th>';
    html += '<th class="text-center" onclick="sortTable(3)" style="cursor: pointer;">Solved <i class="bi bi-arrow-down-up"></i></th>';
    html += '<th class="text-center" onclick="sortTable(4)" style="cursor: pointer;">Blocked <i class="bi bi-arrow-down-up"></i></th>';
    html += '<th class="text-center" onclick="sortTable(5)" style="cursor: pointer;">Total <i class="bi bi-arrow-down-up"></i></th>';
    html += '</tr>';
    html += '</thead>';
    html += '<tbody>';
    
    sortedData.forEach(function(tech) {
        var assignedCount = tech.active_count || 0;
        var solvedCount = tech.solved_count || 0;
        var blockedCount = tech.blocked_count || 0;
        var totalCount = assignedCount + solvedCount + blockedCount;
        
        html += '<tr>';
        html += '<td><strong>' + tech.name + '</strong></td>';
        html += '<td><span class="badge bg-secondary">' + tech.role + '</span></td>';
        html += '<td class="text-center"><span class="badge bg-warning">' + assignedCount + '</span></td>';
        html += '<td class="text-center"><span class="badge bg-success">' + solvedCount + '</span></td>';
        html += '<td class="text-center"><span class="badge bg-danger">' + blockedCount + '</span></td>';
        html += '<td class="text-center"><strong>' + totalCount + '</strong></td>';
        html += '</tr>';
    });
    
    html += '</tbody>';
    html += '</table>';
    html += '</div>';
    
    document.getElementById('workloadDashboard').innerHTML = html;
}

function createWorkloadChart(workloadData) {
    if (!workloadData || workloadData.length === 0) {
        return;
    }
    
    // Sort by workload score (descending)
    var sortedData = workloadData.sort(function(a, b) {
        return (b.active_count || 0) - (a.active_count || 0);
    });
    
    var labels = sortedData.map(function(tech) {
        return tech.name.split(' ')[0]; // First name only for cleaner display
    });
    
    var data = sortedData.map(function(tech) {
        return tech.active_count || 0;
    });
    
    var ctx = document.getElementById('workloadChart').getContext('2d');
    var workloadChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: '#006400', // Unified green color
                borderColor: '#004d00', // Slightly darker green for border
                borderWidth: 1
            }]
        },
        options: {
            // Remove indexAxis to make it vertical (default)
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.parsed.y + ' active requests';
                        }
                    }
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                },
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1,
                        font: {
                            size: 12
                        }
                    }
                }
            }
        }
    });
}

// Table sorting function
function sortTable(columnIndex) {
    var table = document.getElementById('workloadTable');
    var tbody = table.getElementsByTagName('tbody')[0];
    var rows = Array.from(tbody.getElementsByTagName('tr'));
    
    // Determine sort direction (toggle between ascending and descending)
    var isAscending = table.getAttribute('data-sort-direction') !== 'asc';
    table.setAttribute('data-sort-direction', isAscending ? 'asc' : 'desc');
    
    rows.sort(function(a, b) {
        var aValue, bValue;
        
        if (columnIndex === 0) { // Staff Name
            aValue = a.cells[0].textContent.trim();
            bValue = b.cells[0].textContent.trim();
        } else if (columnIndex === 1) { // Role
            aValue = a.cells[1].textContent.trim();
            bValue = b.cells[1].textContent.trim();
        } else { // Numeric columns (2, 3, 4, 5)
            aValue = parseInt(a.cells[columnIndex].textContent.trim()) || 0;
            bValue = parseInt(b.cells[columnIndex].textContent.trim()) || 0;
        }
        
        if (columnIndex <= 1) { // Text sorting
            return isAscending ? aValue.localeCompare(bValue) : bValue.localeCompare(aValue);
        } else { // Numeric sorting
            return isAscending ? aValue - bValue : bValue - aValue;
        }
    });
    
    // Clear tbody and append sorted rows
    tbody.innerHTML = '';
    rows.forEach(function(row) {
        tbody.appendChild(row);
    });
    
    // Update sort icons
    updateSortIcons(columnIndex, isAscending);
}

function updateSortIcons(activeColumn, isAscending) {
    var table = document.getElementById('workloadTable');
    var headers = table.getElementsByTagName('th');
    
    for (var i = 0; i < headers.length; i++) {
        var icon = headers[i].getElementsByTagName('i')[0];
        if (i === activeColumn) {
            icon.className = isAscending ? 'bi bi-arrow-up' : 'bi bi-arrow-down';
        } else {
            icon.className = 'bi bi-arrow-down-up';
        }
    }
}

// Period filter functionality
document.addEventListener('DOMContentLoaded', function() {
    const periodFilter = document.getElementById('periodFilter');
    
    if (periodFilter) {
        periodFilter.addEventListener('change', function() {
            const url = new URL(window.location);
            url.searchParams.set('period', this.value);
            window.location.href = url.toString();
        });
    }
});
</script>

{% endblock %}