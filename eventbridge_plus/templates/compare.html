{% extends 'base.html' %} 
{% block title %}Cross-Event Comparison{% endblock %}

{% block content %}

{# ---- Two small macros for formatting seconds into hh:mm:ss ---- #}
{% macro hms_pair(sec) -%}
  {%- if sec is none -%}-{% else -%}
    {%- set total = (sec|float)|round|int -%}
    {%- set h = total // 3600 -%}
    {%- set m = (total % 3600) // 60 -%}
    {%- set s = total % 60 -%}
    {{ "%02d:%02d:%02d" % (h, m, s) }}
  {%- endif -%}
{%- endmacro %}

{% macro hms_pair_signed(sec) -%}
  {%- if sec is none -%}-{% else -%}
    {%- set sgn = '-' if (sec|float) < 0 else '' -%}
    {%- set total = ((sec|float)|abs)|round|int -%}
    {%- set h = total // 3600 -%}
    {%- set m = (total % 3600) // 60 -%}
    {%- set s = total % 60 -%}
    {{ "%s%02d:%02d:%02d" % (sgn, h, m, s) }}
  {%- endif -%}
{%- endmacro %}

{% macro hms_pair_with_speed(sec) -%}
  {%- if sec is none -%}-{% else -%}
    {%- set total = ((sec|float)|abs)|round|int -%}
    {%- set h = total // 3600 -%}
    {%- set m = (total % 3600) // 60 -%}
    {%- set s = total % 60 -%}
    {%- set speed_text = 'fast' if (sec|float) < 0 else 'slow' -%}
    {{ "%02d:%02d:%02d %s" % (h, m, s, speed_text) }}
  {%- endif -%}
{%- endmacro %}

<div class="container py-3">
  <h3 class="mb-3">Cross-Event Comparison</h3>

  <form class="row g-1 align-items-end mb-3" method="get">

    <!-- Implementing a multi-select drop-down using Choices.js -->
    <div class="col-md-4">
      <label class="form-label">Select Events</label>
      <select id="eventMulti" name="event_id" class="form-select" multiple>
        {% for ev in event_list %}
          {% set val = ev.event_id|string %}
          <option value="{{ val }}" {% if selected_event_ids and (val in selected_event_ids) %}selected{% endif %}>
            {{ ev.event_title }} ({{ ev.event_date|nz_date }})
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-2">
      <label class="form-label">From</label>
      <input type="date" name="date_from" class="form-control" value="{{ date_from or '' }}" lang="en-NZ">
    </div>
    <div class="col-md-2">
      <label class="form-label">To</label>
      <input type="date" name="date_to" class="form-control" value="{{ date_to or '' }}" lang="en-NZ" >
    </div>

    <!-- NEW: Event Location -->
    <!-- <div class="col-md-3">
      <label class="form-label">Event Location</label>
      <select name="location" class="form-select">
        <option value="All Locations" {{ 'selected' if selected_location=='All Locations' else '' }}>All Locations</option>
        {% for loc in locations %}
          <option value="{{ loc }}" {{ 'selected' if selected_location==loc else '' }}>{{ loc }}</option>
        {% endfor %}
      </select>
    </div> -->

    <!-- NEW: Event Type -->
    <div class="col-md-2">
      <label class="form-label">Event Type</label>
      <select name="event_type" class="form-select">
        <option value="All" {{ 'selected' if selected_event_type=='All' else '' }}>All Types</option>
        {% for tp in event_types %}
          <option value="{{ tp }}" {{ 'selected' if selected_event_type==tp else '' }}>{{ tp }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-auto d-flex align-items-end">
      <div class="d-flex gap-1">
        <button class="btn btn-activeloop btn-compact d-inline-flex align-items-center" type="submit">
          <i class="bi bi-arrow-repeat me-1"></i>Apply
        </button>
        <a class="btn btn-outline-activeloop btn-compact d-inline-flex align-items-center" href="{{ url_for('compare_view') }}" title="Reset" aria-label="Reset">
          <i class="bi bi-arrow-counterclockwise"></i>
        </a>
      </div>
    </div>
  </form>

  <!-- Highlights -->
  <div class="row g-3 mb-3">
    <div class="col-md-4">
      <div class="card shadow-sm h-100"><div class="card-body d-flex flex-column">
        <div class="fw-bold">Personal Best (PB)</div>
        <div class="fs-4">{{ hms_pair(pb) }}</div>
        <small class="text-muted mt-auto">Hurray! This is your Personal Best - push yourself harder!</small>
      </div></div>
    </div>
    <div class="col-md-4">
      <div class="card shadow-sm h-100"><div class="card-body d-flex flex-column">
        <div class="fw-bold">Me vs Past Me (%)</div>
        <div class="fs-4">
          {% if pct_improve is not none %}
            {{ pct_improve|abs }}% {% if pct_improve > 0 %}faster{% else %}slower{% endif %}
          {% else %}
            -
          {% endif %}
        </div>
        <div class="mt-auto">
          <small class="text-muted">Comparing finish time improvement across the average results you got</small><br>
          <small class="text-muted">(past events - recent events) / past events</small>
        </div>
      </div></div>
    </div>
    <div class="col-md-4">
      <div class="card shadow-sm h-100"><div class="card-body d-flex flex-column">
        <div class="fw-bold">Me vs Events Avg</div>
        <div class="fs-4">{{ hms_pair_with_speed(avg_diff) }}</div>
        <small class="text-muted mt-auto">How much fast or slow you are compared to all event averages</small>
      </div></div>
    </div>
  </div>

  <!-- Trend Chart -->
  <div class="card mb-3">
    <div class="card-body">
      <h6 class="mb-3">Time Trend</h6>
      <canvas id="trendChart" height="100"></canvas>
    </div>
  </div>

  <!-- Tables -->
  <div class="card">
    <div class="card-body">
      <h6 class="mb-3">Per-Event Details</h6>
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead><tr>
            <th>Date</th><th>Event</th><th>Type</th><th>My Finish</th><th>Avg</th><th>Compare Avg</th><th>Rank</th><th>Actions</th> <!-- NEW -->
          </tr></thead>
          <tbody>
          {% for r in user_rows %}
            {% set avg = (avg_rows|selectattr('event_id','equalto', r.event_id)|list|first) %}
            {% set diff = (r.finish_seconds - (avg.avg_finish if avg else 0)) if avg else None %}
            <tr>
              <td>{{ r.event_date|nz_date }}</td>
              <td>{{ r.event_title }}</td>
              <td>{{ r.event_type }}</td>
              <td>{{ r.finish_hms_pair or hms_pair(r.finish_seconds) }}</td>
              <td>{{ r.avg_hms_pair or (hms_pair(avg.avg_finish) if avg and avg.avg_finish is not none else '—') }}</td>
              <td>
                {% if diff is not none %}
                  {{ r.diff_hms_pair or hms_pair(abs(diff)) }} {% if diff < 0 %}fast{% else %}slow{% endif %}
                {% else %}
                  —
                {% endif %}
              </td>
              <td>
                {% if r.my_rank and r.total_finishers %}
                  {{ r.my_rank }} / {{ r.total_finishers }}
                {% else %}
                  -
                {% endif %}
              </td>
              <td>
                <a href="{{ url_for('view_event_results', event_id=r.event_id) }}" 
                  class="btn btn-outline-primary btn-sm">
                  View All Results
                </a>
              </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
      {% if not user_rows %}
        <div class="text-muted">No results under current filters.</div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Modal for "View all results" -->
<div class="modal fade" id="allResultsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">All Results</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-2">
          <small class="text-muted">Event average:</small>
          <span class="fw-semibold js-event-avg">-</span>
        </div>
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th>Rank</th>
                <th>Membership ID</th>
                <th>Username</th>
                <th>Start Time</th>   
                <th>End Time</th>     
                <th>Finish</th>
                <th>Rank</th>
              </tr>
            </thead>
            <tbody class="js-results-body">
              <tr><td colspan="4" class="text-muted">No data</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>


<!-- External Libraries -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">
<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Initialize Choices.js -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const el = document.getElementById('eventMulti');
  if (el) {
    new Choices(el, {
      removeItemButton: true,
      placeholder: true,
      placeholderValue: 'Select one or more events…',
      searchPlaceholderValue: 'Search events…',
      shouldSort: false,
      position: 'bottom'
    });
  }
});
</script>

<!-- Chart.js -->
<script>
(function () {
  const _dates = {{ user_rows|map(attribute='event_date')|map('nz_date')|list|tojson }};
  const _names = {{ user_rows|map(attribute='event_title')|list|tojson }};
  const labels = _dates.map((d, i) => [d, _names[i]]);

  const myTimes  = {{ user_rows|map(attribute='finish_seconds')|list|tojson }};
  const evIds    = {{ user_rows|map(attribute='event_id')|list|tojson }};
  const avgRows  = {{ avg_rows|tojson }};
  const avgById = {};
  (avgRows || []).forEach(r => { avgById[r.event_id] = (r.avg_finish == null ? null : Number(r.avg_finish)); });
  const avgTimes = evIds.map(id => (avgById.hasOwnProperty(id) ? avgById[id] : null));
  const hasData = Array.isArray(myTimes) && myTimes.length > 0;
  const canvas = document.getElementById('trendChart');
  if (!hasData || !canvas) return;
  const ctx = canvas.getContext('2d');
  
  // Helper function to format seconds to HH:MM:SS
  function formatTime(seconds) {
    const h = Math.floor(seconds / 3600);
    const m = Math.floor((seconds % 3600) / 60);
    const s = Math.floor(seconds % 60);
    return `${h}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
  }
  
  new Chart(ctx, {
    type: 'line',
    data: { labels, datasets: [
      { label: 'Your Finish', data: myTimes, tension: 0.3, borderWidth: 4, pointRadius: 5, pointBorderWidth: 2, borderColor: 'rgb(75, 192, 192)', backgroundColor: 'rgba(75, 192, 192, 0.2)' },
      { label: 'Event Average', data: avgTimes, tension: 0.3, borderWidth: 4, pointRadius: 5, pointBorderWidth: 2, borderColor: 'rgb(255, 99, 132)', backgroundColor: 'rgba(255, 99, 132, 0.2)' }
    ]},
    options: {
    responsive: true,
    interaction: { mode: 'nearest', intersect: false },
    scales: {
      y: { 
        title: { display: true, text: 'Time' },
        ticks: {
          callback: function(value) {
            return formatTime(value);
          }
        }
      },
      x: {
        ticks: {
          autoSkip: false,   // Do not automatically skip
          maxRotation: 0,   
          minRotation: 0    
        }
      }
    },
    plugins: { 
      legend: { position: 'top' },
      tooltip: {
        callbacks: {
          label: function(context) {
            let label = context.dataset.label || '';
            if (label) {
              label += ': ';
            }
            label += formatTime(context.parsed.y);
            return label;
          }
        }
      }
    }
  }
  });
})();
</script>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const modalEl = document.getElementById('allResultsModal');
  const modal   = new bootstrap.Modal(modalEl);
  const bodyEl  = modalEl.querySelector('.js-results-body');
  const avgEl   = modalEl.querySelector('.js-event-avg');
  const titleEl = modalEl.querySelector('.modal-title');

  document.querySelectorAll('.view-results-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const eventId = btn.dataset.eventId;
      const title   = btn.dataset.eventTitle || 'All Results';
      titleEl.textContent = `All Results — ${title}`;
      bodyEl.innerHTML = `<tr><td colspan="4" class="text-muted">Loading…</td></tr>`;
      avgEl.textContent = '-';

      try {
        const resp = await fetch(`/events/${eventId}/results/all.json`);
        const data = await resp.json();
        const fmt = (v)=>{
          const t = Number(v);
          if (!isFinite(t)) return '-';
          const h = Math.floor(t/3600);
          const m = Math.floor((t%3600)/60);
          const s = Math.floor(t%60);
          return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
        };
        avgEl.textContent = (data.avg_finish != null ? fmt(data.avg_finish) : '-');

        const rows = (data.items || []).map(it => `
          <tr>
            <td>${it.membership_id}</td>
            <td>${it.username ?? ''}</td>
            <td>${it.elapsed_sec != null ? fmt(it.elapsed_sec) : '-'}</td>
            <td>${it.rank ?? '-'}</td>
          </tr>`).join('');

        bodyEl.innerHTML = rows || `<tr><td colspan="4" class="text-muted">No valid results</td></tr>`;
      } catch (e) {
        bodyEl.innerHTML = `<tr><td colspan="4" class="text-danger">Failed to load</td></tr>`;
      }

      modal.show();
    });
  });
});
</script>

{% endblock %}
