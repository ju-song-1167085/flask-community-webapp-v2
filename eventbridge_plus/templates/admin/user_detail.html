{% extends 'base.html' %}
{% block title %}{{ user.first_name }} {{ user.last_name }} - Profile{% endblock %}
{% set active_page = 'users' %}

{% block content %}
<div class="container-fluid py-4">

  <!-- Header -->
  <div class="card mb-3">
    <div class="card-header d-flex align-items-center justify-content-between">
      <div class="d-flex align-items-center">
        <a href="{{ url_for('admin_users_list') }}" class="btn btn-outline-secondary me-3">
          <i class="bi bi-arrow-left"></i>
        </a>
        <h1 class="page-title mb-0">User Profile</h1>
      </div>
      <div class="d-flex gap-2">
        <!-- Edit Profile Button -->
        <a href="{{ url_for('admin_profile_edit_page', user_id=user.user_id) }}" class="btn btn-primary">
          <i class="bi bi-pencil-square me-2"></i>Edit Profile
        </a>
      </div>
    </div>
  </div>

  <div class="row g-3">
    <!-- Left: core info -->
    <div class="col-lg-4">
      <div class="card h-100">
        <div class="card-body text-center">
          <img src="{% if user.user_image %}{{ url_for('static', filename=user.user_image) }}{% else %}{{ url_for('static', filename='img/avatar-default.png') }}{% endif %}"
               class="rounded-circle mb-3" style="width: 96px; height: 96px; object-fit: cover;" alt="Avatar">

          <h4 class="mb-1">{{ user.first_name }} {{ user.last_name }}</h4>
          <div class="text-muted mb-2">@{{ user.username }}</div>

          {% if user.status == 'active' %}
            <span class="badge badge-ok mb-3">Active</span>
          {% else %}
            <span class="badge badge-danger-soft mb-3">Banned</span>
          {% endif %}

          <hr>
          
          <!-- Basic Info -->
          <div class="text-start">
            <p><strong>Email:</strong><br>{{ user.email }}</p>
            
            <!-- ENHANCED: Role Display with Icons -->
            <p><strong>Role:</strong><br>
              {% if user.platform_role == 'super_admin' %}
                <span class="badge bg-danger fs-6">
                  <i class="bi bi-shield-fill me-1"></i>Super Admin
                </span>
              {% elif user.platform_role == 'support_technician' %}
                <span class="badge bg-info fs-6">
                  <i class="bi bi-tools me-1"></i>Support Technician
                </span>
              {% else %}
                <span class="badge bg-secondary fs-6">
                  <i class="bi bi-person me-1"></i>Participant
                </span>
              {% endif %}
            </p>
            
            {% if user.location %}
              <p><strong>Location:</strong><br>{{ user.location }}</p>
            {% endif %}
            {% if user.biography %}
              <p><strong>Biography:</strong><br>{{ user.biography }}</p>
            {% endif %}
            
            <!-- Ban Info -->
            {% if user.status == 'banned' %}
              <hr>
              <div class="alert alert-danger">
                <strong>Ban Information:</strong><br>
                {% if user.banned_reason %}
                  Reason: {{ user.banned_reason }}<br>
                {% endif %}
                {% if user.banned_at %}
                  Date: {{ user.banned_at|nz_date }}<br>
                {% endif %}
                {% if banned_by_admin %}
                  By: {{ banned_by_admin.first_name }} {{ banned_by_admin.last_name }}
                {% endif %}
              </div>
            {% endif %}
          </div>
        </div>
      </div>


    </div>

    <!-- Right: Activity Info -->
    <div class="col-lg-8">
      <!-- Admin Management Actions -->
      {% if session.get('platform_role') == 'super_admin' and user.user_id != session.get('user_id') %}
      <div class="card mb-3">
        <div class="card-header">
          <h6 class="mb-0">
            <i class="bi bi-shield-fill text-danger me-2"></i>User Controls
          </h6>
        </div>
        <div class="card-body">
          <div class="d-flex gap-2 flex-wrap">
            {% if user.status == 'active' %}
              <button class="btn btn-outline-danger" onclick="openBan()">
                <i class="bi bi-ban me-2"></i>Ban User
              </button>
            {% else %}
              <button class="btn btn-outline-success" onclick="openUnban()">
                <i class="bi bi-check-circle me-2"></i>Unban User
              </button>
            {% endif %}
            
            <button class="btn btn-outline-primary" onclick="openChangeRole()">
              <i class="bi bi-person-gear me-2"></i>Change Role
            </button>
            
            <button class="btn btn-outline-danger" onclick="openDeleteUser()">
              <i class="bi bi-trash me-2"></i>Delete User
            </button>
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Stats -->
      <div class="card mb-3">
        <div class="card-header">
          <h5 class="mb-0">Activity Summary</h5>
        </div>
        <div class="card-body">
          <div class="row text-center">
            <div class="col-md-3">
              <h3 class="text-primary">{{ user_stats.active_groups or 0 }}</h3>
              <small class="text-muted">Active Groups</small>
            </div>
            <div class="col-md-3">
              <h3 class="text-success">{{ user_stats.total_events or 0 }}</h3>
              <small class="text-muted">Total Events</small>
            </div>
            <div class="col-md-3">
              <h3 class="text-info">{{ user_stats.attended_events or 0 }}</h3>
              <small class="text-muted">Attended</small>
            </div>
            <div class="col-md-3">
              <h3 class="text-warning">{{ user_stats.total_volunteer_hours or 0 }}</h3>
              <small class="text-muted">Vol. Hours</small>
            </div>
          </div>
        </div>
      </div>


      <!-- Groups -->
      <div class="card mb-3">
        <div class="card-header">
          <h5 class="mb-0">Group Memberships</h5>
        </div>
        <div class="card-body">
          {% if user_groups %}
            <div class="table-responsive">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>Group</th>
                    <th>Role</th>
                    <th>Status</th>
                    <th>Joined</th>
                  </tr>
                </thead>
                <tbody>
                  {% for group in user_groups %}
                  <tr>
                    <td>{{ group.group_name }}</td>
                    <td><span class="badge bg-light text-dark">{{ group.group_role }}</span></td>
                    <td>
                      {% if group.membership_status == 'active' %}
                        <span class="badge bg-success">Active</span>
                      {% else %}
                        <span class="badge bg-secondary">{{ group.membership_status }}</span>
                      {% endif %}
                    </td>
                    <td>{{ group.join_date|nz_date if group.join_date else '-' }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <p class="text-muted">No group memberships found.</p>
          {% endif %}
        </div>
      </div>

      <!-- Recent Events -->
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">Recent Events</h5>
        </div>
        <div class="card-body">
          {% if user_events %}
            <div class="table-responsive">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>Event</th>
                    <th>Date</th>
                    <th>Role</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  {% for event in user_events %}
                  <tr>
                    <td>{{ event.event_title }}</td>
                    <td>{{ event.event_date|nz_date if event.event_date else '-' }}</td>
                    <td><span class="badge bg-light text-dark">{{ event.event_role }}</span></td>
                    <td>
                      {% if event.participation_status == 'attended' %}
                        <span class="badge bg-success">Attended</span>
                      {% else %}
                        <span class="badge bg-secondary">{{ event.participation_status }}</span>
                      {% endif %}
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <p class="text-muted">No event participation found.</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Ban Modal -->
<div class="modal fade" id="banModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="POST" action="{{ url_for('admin_ban_user', user_id=user.user_id) }}">
        <div class="modal-header">
          <h5 class="modal-title">Ban User</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p>You are about to ban: <strong>{{ user.username }}</strong></p>
          <div class="mb-3">
            <label class="form-label">Reason for Ban *</label>
            <textarea name="reason" class="form-control" rows="3" required 
                      placeholder="Please provide a reason for banning this user..."></textarea>
          </div>
          <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle me-2"></i>
            This will remove the user from all groups and cancel their event registrations.
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-danger">Ban User</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Unban Modal -->
<div class="modal fade" id="unbanModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="POST" action="{{ url_for('admin_unban_user', user_id=user.user_id) }}">
        <div class="modal-header">
          <h5 class="modal-title">Unban User</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p>Are you sure you want to unban: <strong>{{ user.username }}</strong>?</p>
          <p class="text-muted">This will restore their account access.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success">Unban User</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- NEW: Change Role Modal -->
<div class="modal fade" id="changeRoleModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Change User Role</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form method="POST" action="{{ url_for('admin_change_user_role', user_id=user.user_id) }}">
        <div class="modal-body">
          <!-- Warning Alert -->
          <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <strong>Warning:</strong> Changing a user's role will affect their access permissions immediately.
          </div>
          
          <!-- Current User Info -->
          <div class="mb-3">
            <label class="form-label"><strong>User:</strong></label>
            <p class="form-control-plaintext">{{ user.first_name }} {{ user.last_name }} (@{{ user.username }})</p>
          </div>
          
          <!-- Current Role Display -->
          <div class="mb-3">
            <label class="form-label"><strong>Current Role:</strong></label>
            <p class="form-control-plaintext">
              {% if user.platform_role == 'super_admin' %}
                <span class="badge bg-danger fs-6">
                  <i class="bi bi-shield-fill me-1"></i>Super Admin
                </span>
              {% elif user.platform_role == 'support_technician' %}
                <span class="badge bg-info fs-6">
                  <i class="bi bi-tools me-1"></i>Support Technician
                </span>
              {% else %}
                <span class="badge bg-secondary fs-6">
                  <i class="bi bi-person me-1"></i>Participant
                </span>
              {% endif %}
            </p>
          </div>
          
          <!-- New Role Selection -->
          <div class="mb-3">
            <label for="newRole" class="form-label"><strong>New Role:</strong></label>
            <select class="form-select" id="newRole" name="new_role" required>
              <option value="">Select new role...</option>
              <option value="participant" {% if user.platform_role == 'participant' %}disabled{% endif %}>
                Participant
              </option>
              <option value="support_technician" {% if user.platform_role == 'support_technician' %}disabled{% endif %}>
                Support Technician
              </option>
              <option value="super_admin" {% if user.platform_role == 'super_admin' %}disabled{% endif %}>
                Super Admin
              </option>
            </select>
            
            <!-- Role Descriptions -->
            <div class="form-text">
              <strong>Participant:</strong> Can join events and groups<br>
              <strong>Support Technician:</strong> Can view user profiles and assist users<br>
              <strong>Super Admin:</strong> Full system access and user management
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-person-gear me-2"></i>Change Role
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete User Modal -->
<div class="modal fade" id="deleteUserModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title text-danger">
          <i class="bi bi-exclamation-triangle me-2"></i>Delete User
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form method="POST" action="{{ url_for('admin_delete_user', user_id=user.user_id) }}">
        <div class="modal-body">
          <div class="alert alert-danger">
            <strong>Warning!</strong> This action cannot be undone.
          </div>
          <p>Are you sure you want to delete <strong>{{ user.first_name }} {{ user.last_name }}</strong> ({{ user.username }})?</p>
          <p>This will:</p>
          <ul>
            <li>Permanently delete the user account</li>
            <li>Remove them from all groups</li>
            <li>Cancel all their event registrations</li>
            <li>Delete all their notifications</li>
            <li>Send a goodbye email to {{ user.email }}</li>
          </ul>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-danger">
            <i class="bi bi-trash me-2"></i>Delete User
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
// Function to open ban modal
function openBan() { new bootstrap.Modal(document.getElementById('banModal')).show(); }

// Function to open unban modal
function openUnban() { new bootstrap.Modal(document.getElementById('unbanModal')).show(); }

// NEW: Function to open role change modal
function openChangeRole() { new bootstrap.Modal(document.getElementById('changeRoleModal')).show(); }

// Function to open delete user modal
function openDeleteUser() { new bootstrap.Modal(document.getElementById('deleteUserModal')).show(); }
</script>
{% endblock %}
